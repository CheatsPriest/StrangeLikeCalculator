<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—ã—Ä–∞–∂–µ–Ω–∏–π –∏ –º–Ω–æ–≥–æ—á–ª–µ–Ω–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .calculator-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            margin-top: 20px;
        }
        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        .example-btn {
            margin: 5px;
            font-size: 0.85rem;
        }
        .loader {
            display: none;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="calculator-card">
                    <h1 class="text-center mb-4">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—ã—Ä–∞–∂–µ–Ω–∏–π –∏ –º–Ω–æ–≥–æ—á–ª–µ–Ω–æ–≤</h1>
                    
                    <form id="calcForm">
                        <div class="mb-3">
                            <label class="form-label">–¢–∏–ø –≤—ã—á–∏—Å–ª–µ–Ω–∏—è:</label>
                            <select class="form-select" id="calcType" name="calculation_type" required>
                                <option value="expression">–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ</option>
                                <option value="polynomial">–ö–æ—Ä–Ω–∏ –º–Ω–æ–≥–æ—á–ª–µ–Ω–∞</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label" id="expressionLabel">–í—ã—Ä–∞–∂–µ–Ω–∏–µ:</label>
                            <input type="text" class="form-control" id="expression" name="expression" 
                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2+2 –∏–ª–∏ x^2+8" required>
                            
                            <div class="mt-2">
                                <small class="text-muted" id="hintText">
                                    –ü—Ä–∏–º–µ—Ä—ã: 2+2, 3*5, (2+3)*(4+5)
                                </small>
                            </div>
                            
                            <div class="mt-2" id="examplesContainer">
                                <!-- –ü—Ä–∏–º–µ—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <span id="submitText">–í—ã—á–∏—Å–ª–∏—Ç—å</span>
                                <span id="loader" class="loader" style="display: none;"></span>
                            </button>
                        </div>
                    </form>
                    
                    <div id="resultCard" class="result-card">
                        <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
                        <div id="resultContent"></div>
                        <div class="mt-3 text-muted small" id="cacheInfo"></div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h6>
                                        <button class="btn btn-outline-info btn-sm" onclick="getStats()">
                                            –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞
                                        </button>
                                        <div id="statsResult" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è</h6>
                                        <button class="btn btn-outline-success btn-sm" onclick="checkHealth()">
                                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
                                        </button>
                                        <div id="healthResult" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="calculator-card mt-3">
                    <h5>üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h5>
                    <ul>
                        <li><strong>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ +, -, *, /, ** (—Å—Ç–µ–ø–µ–Ω—å), % (–æ—Å—Ç–∞—Ç–æ–∫), —Å–∫–æ–±–∫–∏</li>
                        <li><strong>–ú–Ω–æ–≥–æ—á–ª–µ–Ω—ã:</strong> –§–æ—Ä–º–∞—Ç: <code>3x^3+4x^10-5x^20</code> –∏–ª–∏ <code>x^2+x+1</code></li>
                        <li>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –º–Ω–æ–≥–æ—á–ª–µ–Ω—ã –¥–æ 100 —Å—Ç–µ–ø–µ–Ω–∏</li>
                        <li>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
        document.getElementById('calcType').addEventListener('change', function() {
            updateUI();
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤
        async function loadExamples() {
            try {
                const response = await fetch('/api/examples');
                const data = await response.json();
                
                const container = document.getElementById('examplesContainer');
                container.innerHTML = '<small class="text-muted">–ü—Ä–∏–º–µ—Ä—ã:</small><br>';
                
                // –ü—Ä–∏–º–µ—Ä—ã –≤—ã—Ä–∞–∂–µ–Ω–∏–π
                data.expressions.forEach(example => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-outline-secondary btn-sm example-btn';
                    btn.textContent = example;
                    btn.onclick = () => {
                        document.getElementById('expression').value = example;
                        document.getElementById('calcType').value = 'expression';
                        updateUI();
                    };
                    container.appendChild(btn);
                });
                
                // –ü—Ä–∏–º–µ—Ä—ã –º–Ω–æ–≥–æ—á–ª–µ–Ω–æ–≤
                data.polynomials.forEach(example => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-outline-primary btn-sm example-btn';
                    btn.textContent = example;
                    btn.onclick = () => {
                        document.getElementById('expression').value = example;
                        document.getElementById('calcType').value = 'polynomial';
                        updateUI();
                    };
                    container.appendChild(btn);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–º–µ—Ä–æ–≤:', error);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞
        function updateUI() {
            const type = document.getElementById('calcType').value;
            const label = document.getElementById('expressionLabel');
            const hint = document.getElementById('hintText');
            const input = document.getElementById('expression');
            
            if (type === 'expression') {
                label.textContent = '–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ:';
                hint.textContent = '–ü—Ä–∏–º–µ—Ä—ã: 2+2, 3*5, (2+3)*(4+5), 2**3 (—Å—Ç–µ–ø–µ–Ω—å), 17%5 (–æ—Å—Ç–∞—Ç–æ–∫)';
                input.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: 2+2 –∏–ª–∏ 3*5+(10-2)';
            } else {
                label.textContent = '–ú–Ω–æ–≥–æ—á–ª–µ–Ω:';
                hint.textContent = '–§–æ—Ä–º–∞—Ç: 3x^3+4x^10-5x^20 –∏–ª–∏ x^2+x+1';
                input.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: x^2+8 –∏–ª–∏ 3x^3-2x^2+x-1';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('calcForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.querySelector('#calcForm button[type="submit"]');
            const submitText = document.getElementById('submitText');
            const loader = document.getElementById('loader');
            
            // –ü–æ–∫–∞–∑–∞—Ç—å loader
            submitText.style.display = 'none';
            loader.style.display = 'inline-block';
            submitBtn.disabled = true;
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/calculate', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                showResult(result);
                
            } catch (error) {
                showResult({
                    success: false,
                    error: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message
                });
            } finally {
                // –°–∫—Ä—ã—Ç—å loader
                submitText.style.display = 'inline-block';
                loader.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showResult(result) {
            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');
            const cacheInfo = document.getElementById('cacheInfo');
            
            resultCard.style.display = 'block';
            
            if (result.success) {
                if (result.type === 'expression') {
                    resultContent.innerHTML = `
                        <div class="alert alert-success">
                            <h5>${result.expression} = <strong>${result.result}</strong></h5>
                            <p class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è</p>
                        </div>
                    `;
                    
                    cacheInfo.innerHTML = result.from_cache 
                        ? `‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∑—è—Ç –∏–∑ –∫—ç—à–∞ (–≤—Ä–µ–º—è: ${result.calculation_time_ms} –º—Å)`
                        : `üîÑ –í—ã—á–∏—Å–ª–µ–Ω–æ –≤–ø–µ—Ä–≤—ã–µ (–≤—Ä–µ–º—è: ${result.calculation_time_ms} –º—Å)`;
                        
                } else if (result.type === 'polynomial') {
                    let rootsHtml = '<ul class="mb-0">';
                    result.roots.forEach(root => {
                        rootsHtml += `<li>${root}</li>`;
                    });
                    rootsHtml += '</ul>';
                    
                    resultContent.innerHTML = `
                        <div class="alert alert-info">
                            <p><strong>–°—Ç–µ–ø–µ–Ω—å:</strong> ${result.degree}</p>
                            <p><strong>–ö–æ—Ä–Ω–∏:</strong></p>
                            ${rootsHtml}
                            <p class="mb-0"><strong>–í–µ—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π:</strong> ${result.real_roots.length}</p>
                            <p class="mb-0"><strong>–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π:</strong> ${result.complex_roots}</p>
                        </div>
                    `;
                    
                    cacheInfo.innerHTML = result.from_cache 
                        ? `‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∑—è—Ç –∏–∑ –∫—ç—à–∞ (–≤—Ä–µ–º—è: ${result.calculation_time_ms} –º—Å)`
                        : `üîÑ –í—ã—á–∏—Å–ª–µ–Ω–æ –≤–ø–µ—Ä–≤—ã–µ (–≤—Ä–µ–º—è: ${result.calculation_time_ms} –º—Å)`;
                }
            } else {
                resultContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå –û—à–∏–±–∫–∞!</h5>
                        <p class="mb-0">${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                    </div>
                `;
                cacheInfo.innerHTML = '';
            }
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            resultCard.scrollIntoView({ behavior: 'smooth' });
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        async function getStats() {
            try {
                const response = await fetch('http://localhost:8000/cache/stats');
                const stats = await response.json();
                
                const statsResult = document.getElementById('statsResult');
                statsResult.innerHTML = `
                    <div class="alert alert-light">
                        <p><strong>–í—ã—Ä–∞–∂–µ–Ω–∏—è –≤ –∫—ç—à–µ:</strong> ${stats.expressions_cache.total_entries}</p>
                        <p><strong>–û–±—Ä–∞—â–µ–Ω–∏–π –∫ –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º:</strong> ${stats.expressions_cache.total_accesses}</p>
                        <p><strong>–ú–Ω–æ–≥–æ—á–ª–µ–Ω–æ–≤ –≤ –∫—ç—à–µ:</strong> ${stats.polynomials_cache.total_entries}</p>
                        <p><strong>–û–±—Ä–∞—â–µ–Ω–∏–π –∫ –º–Ω–æ–≥–æ—á–ª–µ–Ω–∞–º:</strong> ${stats.polynomials_cache.total_accesses}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('statsResult').innerHTML = `
                    <div class="alert alert-warning">
                        –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}
                    </div>
                `;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const health = await response.json();
                
                const healthResult = document.getElementById('healthResult');
                let html = '<div class="alert alert-light">';
                
                if (health.status === 'healthy') {
                    html += `<p>‚úÖ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: <strong>—Ä–∞–±–æ—Ç–∞–µ—Ç</strong></p>`;
                    
                    if (health.gateway && health.gateway.status === 'healthy') {
                        html += `<p>‚úÖ Gateway —Å–µ—Ä–≤–∏—Å: <strong>—Ä–∞–±–æ—Ç–∞–µ—Ç</strong></p>`;
                        html += `<p>üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${health.gateway.database || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>`;
                    } else {
                        html += `<p>‚ùå Gateway —Å–µ—Ä–≤–∏—Å: <strong>–Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω</strong></p>`;
                    }
                } else {
                    html += `<p>‚ùå –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: <strong>–æ—à–∏–±–∫–∞</strong></p>`;
                    html += `<p>${health.error || ''}</p>`;
                }
                
                html += '</div>';
                healthResult.innerHTML = html;
                
            } catch (error) {
                document.getElementById('healthResult').innerHTML = `
                    <div class="alert alert-danger">
                        –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è: ${error.message}
                    </div>
                `;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            updateUI();
            loadExamples();
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>